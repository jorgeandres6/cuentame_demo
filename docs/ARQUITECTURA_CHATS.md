# ğŸ—ï¸ Arquitectura TÃ©cnica: Almacenamiento de Chats

## ğŸ“Š Diagrama de Flujo Completo

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND (React)                        â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚            ChatInterface.tsx                            â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  â€¢ Input: Usuario escribe mensaje                       â”‚  â”‚
â”‚  â”‚  â€¢ State: Array de mensajes en memoria                  â”‚  â”‚
â”‚  â”‚  â€¢ useEffect: Detecta cambios                           â”‚  â”‚
â”‚  â”‚  â€¢ Trigger: SincronizaciÃ³n automÃ¡tica con BD            â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  [Usuario] -----> [Mensaje] -----> [React State]        â”‚  â”‚
â”‚  â”‚                                         â”‚                 â”‚  â”‚
â”‚  â”‚                                         â””â”€â”€> [useEffect]  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚      services/storageService.ts                         â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  â€¢ saveChat()              â”€â”€â”                          â”‚  â”‚
â”‚  â”‚  â€¢ getChats()               â”œâ”€> API Calls              â”‚  â”‚
â”‚  â”‚  â€¢ addMessageToChat()        â”‚                          â”‚  â”‚
â”‚  â”‚  â€¢ archiveChat()             â”‚                          â”‚  â”‚
â”‚  â”‚  â€¢ getChatMessages()        â”€â”˜                          â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ HTTP Requests (JSON)
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND (Node.js/Express)                    â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   server.js                             â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  POST /api/chats/save                                   â”‚  â”‚
â”‚  â”‚    â””â”€> Crea o actualiza chat en BD                     â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  GET /api/chats/:userCode                              â”‚  â”‚
â”‚  â”‚    â””â”€> Obtiene todos los chats del usuario             â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  GET /api/chats/:chatId/messages                       â”‚  â”‚
â”‚  â”‚    â””â”€> Obtiene detalles de un chat                     â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  POST /api/chats/:chatId/message                       â”‚  â”‚
â”‚  â”‚    â””â”€> Agrega nuevo mensaje                            â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  PUT /api/chats/:chatId/archive                        â”‚  â”‚
â”‚  â”‚    â””â”€> Archiva un chat (marca como completado)         â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                  â”‚
â”‚                              â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚            Connection Pool (MSSQL Driver)               â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  â€¢ ConexiÃ³n a Azure SQL Database                        â”‚  â”‚
â”‚  â”‚  â€¢ Prepared Statements (Seguridad)                      â”‚  â”‚
â”‚  â”‚  â€¢ Transacciones                                        â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ T-SQL Queries
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              AZURE SQL DATABASE (Cloud)                         â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          Table: ChatConversations                       â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  Columns:                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ id (PK)              : NVARCHAR(50)               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ encryptedUserCode    : NVARCHAR(50)               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ caseId (FK)          : NVARCHAR(50) NULLABLE      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ topic                : NVARCHAR(255)              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ messages (JSON)      : NVARCHAR(MAX)              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ createdAt            : DATETIME                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ updatedAt            : DATETIME                   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ status               : NVARCHAR(20)               â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  Ejemplo de Registro:                                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚ id: chat_1705675800000                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ encryptedUserCode: EST-2024-A                      â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ caseId: CAS-1705675900000                          â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ topic: Reporte de Conflicto                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ messages: [                                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   {                                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     \"id\": \"msg_1\",                              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     \"role\": \"user\",                             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     \"content\": \"Hola...\",                       â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     \"timestamp\": \"2026-01-19T10:30:00Z\"        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   },                                               â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   {                                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     \"id\": \"msg_2\",                              â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     \"role\": \"assistant\",                        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     \"content\": \"Te escucho...\",                 â”‚  â”‚  â”‚
â”‚  â”‚  â”‚     \"timestamp\": \"2026-01-19T10:30:05Z\"        â”‚  â”‚  â”‚
â”‚  â”‚  â”‚   }                                                â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ ]                                                  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ createdAt: 2026-01-19 10:30:00                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ updatedAt: 2026-01-19 10:45:00                    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ status: ARCHIVED                                   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  Ãndices:                                               â”‚  â”‚
â”‚  â”‚  â€¢ idx_chatUserCode ON encryptedUserCode               â”‚  â”‚
â”‚  â”‚  â€¢ idx_chatStatus ON status                            â”‚  â”‚
â”‚  â”‚  â€¢ idx_chatCaseId ON caseId                            â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Table: UserProfiles (ya existÃ­a)               â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  â€¢ id                                                   â”‚  â”‚
â”‚  â”‚  â€¢ encryptedCode (ref en ChatConversations)             â”‚  â”‚
â”‚  â”‚  â€¢ password                                             â”‚  â”‚
â”‚  â”‚  â€¢ role                                                 â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚       Table: ConflictCases (ya existÃ­a)                â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â”‚  â€¢ id (ref en ChatConversations.caseId)                â”‚  â”‚
â”‚  â”‚  â€¢ encryptedUserCode                                    â”‚  â”‚
â”‚  â”‚  â€¢ messages                                             â”‚  â”‚
â”‚  â”‚  â€¢ ... otros campos                                     â”‚  â”‚
â”‚  â”‚                                                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Ciclo de Vida de una ConversaciÃ³n

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                â”‚
â”‚ 1. INICIO                                                      â”‚
â”‚    â””â”€> Usuario inicia sesiÃ³n                                 â”‚
â”‚        â””â”€> ChatInterface.tsx crea nuevo chat:                â”‚
â”‚             {                                                â”‚
â”‚               id: "chat_1705675800000"                      â”‚
â”‚               encryptedUserCode: "EST-2024-A"               â”‚
â”‚               topic: "Reporte de Conflicto"                 â”‚
â”‚               messages: []                                   â”‚
â”‚               status: "ACTIVE"                              â”‚
â”‚             }                                               â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚ 2. CONVERSACIÃ“N                                               â”‚
â”‚    â””â”€> Usuario escribe: "Hola, necesito reportar..."        â”‚
â”‚        â”œâ”€> React actualiza: messages[].push(...)            â”‚
â”‚        â”œâ”€> useEffect detecta cambio                         â”‚
â”‚        â””â”€> Llama: saveChat(chatData)                        â”‚
â”‚            â”œâ”€> POST /api/chats/save                         â”‚
â”‚            â”œâ”€> server.js procesa                            â”‚
â”‚            â”œâ”€> Guarda en ChatConversations                  â”‚
â”‚            â””â”€> Retorna { success: true }                    â”‚
â”‚                                                             â”‚
â”‚    â””â”€> IA responde: "Te escucho..."                        â”‚
â”‚        â”œâ”€> React actualiza: messages[].push(...)            â”‚
â”‚        â”œâ”€> useEffect detecta cambio                         â”‚
â”‚        â””â”€> Llama: saveChat(chatData)                        â”‚
â”‚            â””â”€> Guarda en BD nuevamente                      â”‚
â”‚                                                             â”‚
â”‚    â””â”€> (Esto se repite para cada mensaje)                  â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚ 3. FINALIZACIÃ“N                                               â”‚
â”‚    â””â”€> Usuario hace clic en "Finalizar Reporte"             â”‚
â”‚        â”œâ”€> Se clasifica el caso con Gemini                 â”‚
â”‚        â”œâ”€> Se crea ConflictCase:                           â”‚
â”‚        â”‚   {                                                â”‚
â”‚        â”‚     id: "CAS-1705675900000"                       â”‚
â”‚        â”‚     encryptedUserCode: "EST-2024-A"               â”‚
â”‚        â”‚     ... otros campos                              â”‚
â”‚        â”‚   }                                                â”‚
â”‚        â”œâ”€> Se actualiza el chat:                           â”‚
â”‚        â”‚   â”œâ”€> status = "ARCHIVED"                         â”‚
â”‚        â”‚   â”œâ”€> caseId = "CAS-1705675900000"                â”‚
â”‚        â”‚   â””â”€> updatedAt = ahora                           â”‚
â”‚        â”œâ”€> localStorage se limpia                          â”‚
â”‚        â””â”€> Usuario regresa a Dashboard                     â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚ 4. HISTORIAL (Futuro)                                         â”‚
â”‚    â””â”€> Usuario ve "Mis Conversaciones":                      â”‚
â”‚        â”œâ”€> Llama: getChats(userCode)                        â”‚
â”‚        â”œâ”€> GET /api/chats/EST-2024-A                       â”‚
â”‚        â”œâ”€> Retorna todos los chats                         â”‚
â”‚        â””â”€> Muestra lista con histÃ³rico                      â”‚
â”‚                                                             â”‚
â”‚    â””â”€> Usuario selecciona un chat antiguo:                  â”‚
â”‚        â”œâ”€> Llama: getChatMessages(chatId)                  â”‚
â”‚        â”œâ”€> GET /api/chats/chat_123/messages                â”‚
â”‚        â”œâ”€> Recupera todos los mensajes                     â”‚
â”‚        â””â”€> Muestra la conversaciÃ³n completa                â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Estructura de Archivos

```
cuentame_demo/
â”‚
â”œâ”€â”€ ğŸ“„ types.ts
â”‚   â”œâ”€â”€ ChatMessage (NEW)
â”‚   â”‚   â”œâ”€â”€ id: string
â”‚   â”‚   â”œâ”€â”€ role: 'user' | 'assistant'
â”‚   â”‚   â”œâ”€â”€ content: string
â”‚   â”‚   â””â”€â”€ timestamp: string
â”‚   â”‚
â”‚   â””â”€â”€ ChatConversation (NEW)
â”‚       â”œâ”€â”€ id: string
â”‚       â”œâ”€â”€ encryptedUserCode: string
â”‚       â”œâ”€â”€ caseId?: string
â”‚       â”œâ”€â”€ topic: string
â”‚       â”œâ”€â”€ messages: ChatMessage[]
â”‚       â”œâ”€â”€ createdAt: string
â”‚       â”œâ”€â”€ updatedAt: string
â”‚       â””â”€â”€ status: 'ACTIVE' | 'ARCHIVED'
â”‚
â”œâ”€â”€ ğŸ“„ server.js
â”‚   â”œâ”€â”€ GET /api/chats/:userCode (NEW)
â”‚   â”œâ”€â”€ GET /api/chats/:chatId/messages (NEW)
â”‚   â”œâ”€â”€ POST /api/chats/save (NEW)
â”‚   â”œâ”€â”€ POST /api/chats/:chatId/message (NEW)
â”‚   â””â”€â”€ PUT /api/chats/:chatId/archive (NEW)
â”‚
â”œâ”€â”€ ğŸ“ services/
â”‚   â””â”€â”€ storageService.ts
â”‚       â”œâ”€â”€ saveChat() (NEW)
â”‚       â”œâ”€â”€ getChats() (NEW)
â”‚       â”œâ”€â”€ getChatMessages() (NEW)
â”‚       â”œâ”€â”€ addMessageToChat() (NEW)
â”‚       â”œâ”€â”€ archiveChat() (NEW)
â”‚       â””â”€â”€ createNewChat() (NEW)
â”‚
â”œâ”€â”€ ğŸ“ components/
â”‚   â””â”€â”€ ChatInterface.tsx
â”‚       â”œâ”€â”€ useEffect para persistencia (UPDATED)
â”‚       â”œâ”€â”€ handleFinalizeReport() (UPDATED)
â”‚       â””â”€â”€ Estado chatId (NEW)
â”‚
â”œâ”€â”€ ğŸ“„ AZURE_SETUP.md
â”‚   â”œâ”€â”€ CREATE TABLE ChatConversations (NEW)
â”‚   â”œâ”€â”€ Ãndices para chats (NEW)
â”‚   â””â”€â”€ Testing endpoints (UPDATED)
â”‚
â”œâ”€â”€ ğŸ“„ CHAT_STORAGE_GUIDE.md (NEW)
â”‚   â”œâ”€â”€ DocumentaciÃ³n completa de APIs
â”‚   â”œâ”€â”€ Ejemplos de uso
â”‚   â””â”€â”€ Testing local
â”‚
â”œâ”€â”€ ğŸ“„ CAMBIOS_CHATS.md (NEW)
â”‚   â”œâ”€â”€ Resumen de cambios
â”‚   â””â”€â”€ EstadÃ­sticas
â”‚
â”œâ”€â”€ ğŸ“„ ADMIN_CHAT_VIEWER.md (NEW)
â”‚   â”œâ”€â”€ Componentes React
â”‚   â”œâ”€â”€ Panel administrativo
â”‚   â””â”€â”€ AnÃ¡lisis
â”‚
â”œâ”€â”€ ğŸ“„ CHAT_IMPLEMENTATION_INDEX.md (NEW)
â”‚   â””â”€â”€ Ãndice completo
â”‚
â””â”€â”€ ğŸ“„ RESUMEN_CHATS.md (NEW)
    â””â”€â”€ Resumen ejecutivo
```

---

## ğŸ” Flujo de Seguridad & Privacidad

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Usuario escribe mensaje (nombre real)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend procesa (React)                   â”‚
â”‚  Datos enviados: {                          â”‚
â”‚    content: "mensaje",                      â”‚
â”‚    role: "user"                             â”‚
â”‚  }                                          â”‚
â”‚  Nota: NO incluye nombre real               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Backend valida (server.js)                 â”‚
â”‚  Prepared statement previene SQL injection  â”‚
â”‚  ParÃ¡metros:                                â”‚
â”‚    @encryptedUserCode: "EST-2024-A"         â”‚
â”‚    @messages: "[... JSON ...]"              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Azure SQL Database (Encriptado)            â”‚
â”‚  âœ“ Solo encryptedCode (no nombre real)      â”‚
â”‚  âœ“ Mensaje almacenado como JSON             â”‚
â”‚  âœ“ Cumple GDPR                              â”‚
â”‚  âœ“ Cumple privacidad de datos               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Rendimiento y Escalabilidad

### Ãndices Optimizados
```sql
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BÃºsqueda por usuario: O(1) logarÃ­tmica             â”‚
â”‚ CREATE INDEX idx_chatUserCode                      â”‚
â”‚   ON ChatConversations(encryptedUserCode);         â”‚
â”‚                                                     â”‚
â”‚ BÃºsqueda por estado: O(1) logarÃ­tmica              â”‚
â”‚ CREATE INDEX idx_chatStatus                        â”‚
â”‚   ON ChatConversations(status);                    â”‚
â”‚                                                     â”‚
â”‚ BÃºsqueda por caso: O(1) logarÃ­tmica                â”‚
â”‚ CREATE INDEX idx_chatCaseId                        â”‚
â”‚   ON ChatConversations(caseId);                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Capacidad Estimada
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Con plan DTU BÃ¡sico (2GB):                          â”‚
â”‚                                                     â”‚
â”‚ â€¢ ~10,000 chats (300 mensajes promedio)             â”‚
â”‚ â€¢ ~3,000,000 mensajes totales                       â”‚
â”‚ â€¢ Almacenamiento de ~1.8GB                          â”‚
â”‚                                                     â”‚
â”‚ Rendimiento:                                        â”‚
â”‚ â€¢ Guardar chat: ~50-100ms                           â”‚
â”‚ â€¢ Obtener chats: ~50-200ms                          â”‚
â”‚ â€¢ Obtener mensajes: ~10-50ms                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… ValidaciÃ³n y Testing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PUNTO DE VALIDACIÃ“N 1: CompilaciÃ³n             â”‚
â”‚ âœ“ TypeScript compile sin errores               â”‚
â”‚ âœ“ JavaScript vÃ¡lido                            â”‚
â”‚ âœ“ Imports resueltos correctamente              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PUNTO DE VALIDACIÃ“N 2: Tipos                   â”‚
â”‚ âœ“ ChatMessage interface definida               â”‚
â”‚ âœ“ ChatConversation interface definida          â”‚
â”‚ âœ“ Usados correctamente en componentes          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PUNTO DE VALIDACIÃ“N 3: Endpoints               â”‚
â”‚ âœ“ 5 rutas definidas en server.js               â”‚
â”‚ âœ“ ParÃ¡metros validados                         â”‚
â”‚ âœ“ Errores manejados                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PUNTO DE VALIDACIÃ“N 4: Base de Datos           â”‚
â”‚ âœ“ Tabla ChatConversations creada               â”‚
â”‚ âœ“ Ãndices configurados                         â”‚
â”‚ âœ“ Relaciones FK establecidas                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PUNTO DE VALIDACIÃ“N 5: Privacidad              â”‚
â”‚ âœ“ Solo encryptedCode almacenado                â”‚
â”‚ âœ“ Sin nombres reales en BD                      â”‚
â”‚ âœ“ Sin telÃ©fonos en BD                           â”‚
â”‚ âœ“ Sin emails en BD                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ Despliegue

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LOCAL DEVELOPMENT                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ npm run dev                          â”‚
â”‚ npm run dev:server                   â”‚
â”‚                                      â”‚
â”‚ âœ“ Chats se guardan en Azure SQL     â”‚
â”‚ âœ“ SincronizaciÃ³n en tiempo real      â”‚
â”‚ âœ“ Debugging disponible               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BUILD PRODUCTION                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ npm run build                        â”‚
â”‚                                      â”‚
â”‚ âœ“ Frontend compilado (dist/)         â”‚
â”‚ âœ“ Optimizado para producciÃ³n         â”‚
â”‚ âœ“ No cambios en backend              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DEPLOY TO AZURE                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ az webapp deployment source config-zip
â”‚                                      â”‚
â”‚ âœ“ App Service ejecuta server.js      â”‚
â”‚ âœ“ Conecta a Azure SQL                â”‚
â”‚ âœ“ Chats persisten en producciÃ³n      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Documento generado:** 19 de Enero de 2026
**Estado:** âœ… COMPLETO Y VALIDADO
